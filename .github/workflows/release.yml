on:
  release:
    types:
      - published

jobs:
  publish:
    permissions:
      contents: read
      id-token: write # required for SonarSource/vault-action-wrapper
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name }}
      RELEASE_NAME: ${{ github.event.release.name }}
      REPOX_URL: 'https://repox.jfrog.io/artifactory'
      ARTIFACTORY_DEPLOY_REPO: sonarsource-npm-public-qa
      NPM_REPOSITORY: 'sonarsource-npm-public'
      SCOPE: '@sonar'
      PACKAGE: 'scan'
    steps:
      - name: Vault
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets:
            development/artifactory/token/SonarSource-sonar-scanner-npm-promoter access_token  | promoter_access_token;
            development/kv/data/npmjs sonartech_npm_token  | npm_token;
            development/kv/data/repox artifactory_url  | repox_url;
      - name: Setup JFrog for deploy
        uses: SonarSource/jfrog-setup-wrapper@907e87c3d2081a98d2ab8cb03284ee6711f1ee83 # tag=3.2.3
        with:
          jfrogAccessToken: ${{ fromJSON(steps.secrets.outputs.vault).promoter_access_token }}
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup
        run: |
          npm config set //registry.npmjs.org/:_authToken=${{ fromJSON(steps.secrets.outputs.vault).npm_token }}
          npm config set //repox.jfrog.io/artifactory/api/npm/:_authToken=${{ fromJSON(steps.secrets.outputs.vault).promoter_access_token }}

      - name: Build the package
        run: |
          npm ci
          VERSION=${RELEASE_TAG} npm run build

      #      - name: Publish the package to Artifactory
      #        run: |
      #          cd build
      #          npm publish --dry-run
      #          echo $(jq '.name = "sonarqube-scanner"' package.json) > package.json
      #          npm publish --dry-run
      #
      - name: Publish the package to npm
        run: |
          cd build
          npm config set //registry.npmjs.org/:_authToken=${{ fromJSON(steps.secrets.outputs.vault).npm_token }}
          npm config list
          npm publish --dry-run
          echo $(jq '.name = "sonarqube-scanner"' package.json) > package.json
          npm publish --dry-run

#      - name: Publish npm package to npmjs
#        working-directory: ${{ steps.local_repo.outputs.dir }}/package
#        env:
#          NPM_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).npm_token }}
#        run: |
#          npm publish --dry-run
#          echo $(jq '.name = "sonarqube-scanner"' package.json) > package.json
#          npm publish --dry-run
